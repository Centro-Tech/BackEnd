name: CI/CD - Backend MimaStore

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy-backend: # Nome do job Ãºnico, focado no backend
    runs-on: ubuntu-latest
    
    steps:
      # 1ï¸âƒ£ Checkout do cÃ³digo
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Java/Maven
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3ï¸âƒ£ Build do backend
      - name: BE - Compilar projeto
        run: |
          echo "ðŸ—ï¸ Iniciando build do backend..."
          cd "Sprint 4 - CleanArch/JavaSpringBoot/projetoMima"
          mvn clean package -DskipTests
          echo "âœ… Build concluÃ­do com sucesso."

      # 4ï¸âƒ£ Criar chave SSH para o runner
      - name: Criar chave SSH
        run: |
          echo "ðŸ”§ Criando chave SSH para o runner..."
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/private_key.pem
          chmod 600 ~/.ssh/private_key.pem
          echo "âœ… Chave criada."

      # 5ï¸âƒ£ Deploy do Backend no Host B (via Host A)
      - name: BE - Deploy no Host Privado (via Bastion)
        run: |
          # --- !! MUDANÃ‡A CRÃTICA !! ---
          # set -e: Falha o script se qualquer comando falhar
          # set -o pipefail: Falha o script se qualquer parte de um "pipe" (|) falhar
          set -e
          set -o pipefail
          # ------------------------------

          mkdir -p logs
          
          # --- Define as variÃ¡veis para clareza ---
          HOST_A=${{ secrets.REMOTE_HOST }}      # IP PÃºblico (Frontend/Bastion)
          HOST_B=${{ secrets.REMOTE_HOST_B }}    # IP Privado (Backend)
          USER=${{ secrets.REMOTE_USER }}        # ec2-user
          KEY_PATH=~/.ssh/private_key.pem       # Chave no runner

          echo "ðŸ›°ï¸ Iniciando deploy do BACKEND para host_b ($HOST_B) via host_a ($HOST_A)..."
          
          echo "ðŸ“¦ [1/3] Enviando cÃ³digo para host_a (bastion)..."
          rsync -rltgoDzvO --delete \
            -e "ssh -i $KEY_PATH -o StrictHostKeyChecking=no" \
            "Sprint 4 - CleanArch/JavaSpringBoot/projetoMima/" \
            "$USER@$HOST_A:/home/$USER/backend_temp_deploy" \
            | tee logs/rsync_to_a.log

          echo "ðŸ”„ [2/3] Conectando no host_a e disparando deploy de ARQUIVOS para host_b..."
          # Este comando conecta no Host A...
          ssh -i $KEY_PATH -o StrictHostKeyChecking=no $USER@$HOST_A "\
              set -e && \
              mkdir -p ~/logs && \
              echo '...[Host A] Copiando chave para o bastion...' && \
              echo '${{ secrets.EC2_SSH_KEY }}' > ~/private_key.pem && chmod 600 ~/private_key.pem && \
              \
              echo '...[Host A] Copiando arquivos de bastion -> host_b ($HOST_B)...' && \
              rsync -rltgoDzvO --delete \
                -e 'ssh -i ~/private_key.pem -o StrictHostKeyChecking=no' \
                /home/$USER/backend_temp_deploy/ \
                $USER@$HOST_B:/home/$USER/backend" \
            | tee logs/rsync_to_b.log

          echo "ðŸš€ [3/3] Conectando no host_a e disparando INSTALAÃ‡ÃƒO/BUILD do Docker no host_b..."
          # Este comando conecta no Host A...
          ssh -i $KEY_PATH -o StrictHostKeyChecking=no $USER@$HOST_A "\
              set -e && \
              echo '...[Host A] Conectando no host_b ($HOST_B) para rodar o Docker...' && \
              \
              # ...que por sua vez conecta no Host B para rodar o script final
              ssh -i ~/private_key.pem -o StrictHostKeyChecking=no $USER@$HOST_B '\
                set -e && \
                LOG_DIR=\"/home/$USER/backend/logs\" && \
                mkdir -p \$LOG_DIR && \
                LOG_FILE=\"\$LOG_DIR/deploy_\$(date +%Y%m%d_%H%M%S).log\" && \
                { \
                  echo \"...[Host B] Iniciando deploy no host_b...\" && \
                  \
                  # --- !! LÃ“GICA DE INSTALAÃ‡ÃƒO DO DOCKER CORRIGIDA !! --- \
                  if ! command -v docker &> /dev/null; then \
                    echo \"...[Host B] âš™ï¸ Docker nÃ£o encontrado. Instalando Docker...\" && \
                    if command -v amazon-linux-extras &> /dev/null; then \
                      echo \"...[Host B] Detectado Amazon Linux 2. Usando 'amazon-linux-extras'....\" && \
                      sudo amazon-linux-extras install docker -y ; \
                    elif command -v dnf &> /dev/null; then \
                      echo \"...[Host B] Detectado RHEL/Fedora/AL2023. Usando 'dnf'....\" && \
                      sudo dnf install -y docker ; \
                    elif command -v apt-get &> /dev/null; then \
                      echo \"...[Host B] Detectado Debian/Ubuntu. Usando 'apt-get'....\" && \
                      sudo apt-get update && sudo apt-get install -y docker.io ; \
                    elif command -v yum &> /dev/null; then \
                      echo \"...[Host B] Detectado RHEL/CentOS. Usando 'yum'....\" && \
                      sudo yum install -y docker ; \
                    else \
                      echo \"...[Host B] ERRO: NÃ£o foi possÃ­vel determinar o gerenciador de pacotes.\" && exit 1 ; \
                    fi && \
                    \
                    echo \"...[Host B] Iniciando e ativando o serviÃ§o Docker...\" && \
                    sudo systemctl enable docker && \
                    sudo systemctl start docker && \
                    (sudo usermod -aG docker $USER || echo \"...[Host B] Aviso: Falha ao adicionar $USER ao grupo docker. Usando sudo.\") && \
                    echo \"...[Host B] âœ… Docker instalado.\" ; \
                  else \
                    echo \"...[Host B] âœ… Docker jÃ¡ estÃ¡ instalado.\" ; \
                  fi && \
                  # -------------------------------------------------- \
                  \
                  cd /home/$USER/backend && \
                  echo \"...[Host B] ðŸ›‘ Parando containers antigos...\" && \
                  (sudo docker stop mimastore-backend || true) && \
                  (sudo docker rm mimastore-backend || true) && \
                  echo \"...[Host B] ðŸ—ï¸ Buildando nova imagem Docker...\" && \
                  sudo docker build -t mimastore-backend . 2>&1 | tee -a \"\$LOG_FILE\" && \
                  echo \"...[Host B] ðŸš€ Subindo novo container...\" && \
                  sudo docker run -d -p 8080:8080 --name mimastore-backend mimastore-backend 2>&1 | tee -a \"\$LOG_FILE\" && \
                  echo \"...[Host B] âœ… Backend (host_b) atualizado e rodando!\" \
                } | tee -a \"\$LOG_FILE\" \
              ' \
            " | tee logs/deploy_docker_on_b.log

          echo "âœ… Deploy finalizado para host_b"
