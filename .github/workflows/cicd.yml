name: CI/CD - Backend MimaStore

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: BE - Compilar projeto
        run: |
          echo "🏗️ Iniciando build do backend..."
          cd "Sprint 4 - CleanArch/JavaSpringBoot/projetoMima"
          mvn clean package -DskipTests
          echo "✅ Build concluído com sucesso."

      - name: Criar chave SSH
        run: |
          echo "[INFO] Criando chave SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/private_key.pem
          chmod 600 ~/.ssh/private_key.pem
          
          echo "[DEBUG] Verificando chave SSH criada:"
          echo "  - Caminho: ~/.ssh/private_key.pem"
          echo "  - Permissões:"
          ls -l ~/.ssh/private_key.pem
          echo "  - Tamanho (bytes): $(wc -c < ~/.ssh/private_key.pem)"
          echo "  - Fingerprint:"
          ssh-keygen -lf ~/.ssh/private_key.pem || echo "[WARN] Não foi possível gerar fingerprint da chave"

      - name: Criar script de deploy para Host B
        run: |
          echo "[INFO] Criando script deploy_on_b.sh..."
          PROJETO_DIR="Sprint 4 - CleanArch/JavaSpringBoot/projetoMima"
          mkdir -p "$PROJETO_DIR"
          
          cat << 'EOF' > "$PROJETO_DIR/deploy_on_b.sh"
          #!/bin/bash
          set -e
          set -x  # DEBUG: mostrar comandos executados

          PROJETO_DIR="$HOME/backend"
          DB_DIR="$HOME/backend/../Banco de Dados"
          LOG_DIR="$PROJETO_DIR/logs"
          LOG_FILE="$LOG_DIR/deploy_$(date +%Y%m%d_%H%M%S).log"

          mkdir -p $LOG_DIR
          exec > >(tee -a "$LOG_FILE") 2>&1

          echo "[Host B] 🚀 Iniciando deploy completo (banco + backend)..."

          # 🧩 Instalar Docker se necessário
          if ! command -v docker &> /dev/null; then
            echo "[Host B] Instalando Docker..."
            if command -v amazon-linux-extras &> /dev/null; then
              sudo amazon-linux-extras install docker -y
            elif command -v dnf &> /dev/null; then
              sudo dnf install -y docker
            elif command -v apt-get &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y docker.io
            else
              sudo yum install -y docker
            fi
            sudo systemctl enable docker
            sudo systemctl start docker
          fi

          # 🧩 Instalar Docker Compose plugin se necessário
          if ! command -v docker-compose &> /dev/null; then
            echo "[Host B] Instalando Docker Compose..."
            DOCKER_COMPOSE_VERSION=2.24.0
            sudo curl -L "https://github.com/docker/compose/releases/download/v$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" \
              -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi

          echo "[Host B] ✅ Docker e Compose prontos."

          # 🧩 Subir containers
          cd "$DB_DIR"
          echo "[Host B] Parando containers antigos (se existirem)..."
          sudo docker compose down || true

          echo "[Host B] 🏗️ Subindo containers com persistência..."
          sudo docker compose up -d --build

          echo "[Host B] ✅ Deploy completo! Containers ativos:"
          sudo docker ps
          EOF

          chmod +x "$PROJETO_DIR/deploy_on_b.sh"

      - name: BE - Deploy no Host Privado (via Bastion)
        run: |
          set -e
          set -x
          mkdir -p logs
          
          HOST_A=${{ secrets.REMOTE_HOST }}
          HOST_B=${{ secrets.REMOTE_HOST_B }}
          USER=${{ secrets.REMOTE_USER }}
          KEY_PATH=~/.ssh/private_key.pem

          echo "[INFO] Iniciando deploy completo (banco + backend)"
          echo "[DEBUG] HOST_A: $HOST_A"
          echo "[DEBUG] HOST_B: $HOST_B"
          echo "[DEBUG] Usuário: $USER"
          echo "[DEBUG] Verificando chave SSH local:"
          ls -l $KEY_PATH || echo "[ERRO] Chave não encontrada"
          file $KEY_PATH || echo "[WARN] Não foi possível identificar o tipo da chave"

          echo "[INFO] 📦 Enviando código para bastion (Host A)..."
          rsync -rltgoDzvO --delete \
            -e "ssh -i $KEY_PATH -o StrictHostKeyChecking=no -o ServerAliveInterval=60" \
            "Sprint 4 - CleanArch/" \
            "$USER@$HOST_A:/home/$USER/backend_temp_deploy" \
            | tee logs/rsync_to_a.log

          echo "[INFO] 🔄 Copiando do bastion para Host B..."
          ssh -i $KEY_PATH -o StrictHostKeyChecking=no -o ServerAliveInterval=60 $USER@$HOST_A "\
            set -x && \
            echo '[DEBUG] Criando chave privada no bastion...' && \
            echo '${{ secrets.EC2_SSH_KEY }}' > ~/private_key.pem && chmod 600 ~/private_key.pem && \
            echo '[DEBUG] Verificando chave criada no bastion:' && ls -l ~/private_key.pem && \
            echo '[DEBUG] Fingerprint:' && ssh-keygen -lf ~/private_key.pem || true && \
            rsync -rltgoDzvO --delete \
              -e 'ssh -i ~/private_key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=60' \
              /home/$USER/backend_temp_deploy/ \
              $USER@$HOST_B:/home/$USER/backend" \
            | tee logs/rsync_to_b.log

          echo "[INFO] 🚀 Executando deploy_on_b.sh no Host B..."
          ssh -i $KEY_PATH -o StrictHostKeyChecking=no -o ServerAliveInterval=60 $USER@$HOST_A "\
            set -x && \
            ssh -i ~/private_key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=60 $USER@$HOST_B 'bash /home/$USER/backend/JavaSpringBoot/projetoMima/deploy_on_b.sh'" \
            | tee logs/deploy_exec.log
