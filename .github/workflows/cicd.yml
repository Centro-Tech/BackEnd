name: CI/CD - Backend MimaStore

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: BE - Compilar projeto
        run: |
          echo "ðŸ—ï¸ Iniciando build do backend..."
          cd "Sprint 4 - CleanArch/JavaSpringBoot/projetoMima"
          mvn clean package -DskipTests
          echo "âœ… Build concluÃ­do com sucesso."

      - name: Criar chave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/private_key.pem
          chmod 600 ~/.ssh/private_key.pem

      - name: Criar script de deploy para Host B
        run: |
          echo "Criando script de deploy..."
          PROJETO_DIR="Sprint 4 - CleanArch/JavaSpringBoot/projetoMima"
          mkdir -p "$PROJETO_DIR"
          
          cat << 'EOF' > "$PROJETO_DIR/deploy_on_b.sh"
          #!/bin/bash
          set -e
          PROJETO_DIR="$HOME/backend"
          DB_DIR="$HOME/backend/../Banco de Dados"
          LOG_DIR="$PROJETO_DIR/logs"
          LOG_FILE="$LOG_DIR/deploy_$(date +%Y%m%d_%H%M%S).log"

          mkdir -p $LOG_DIR
          exec > >(tee -a "$LOG_FILE") 2>&1

          echo "[Host B] ðŸš€ Iniciando deploy completo (banco + backend)..."

          # ðŸ§© Instalar Docker se necessÃ¡rio
          if ! command -v docker &> /dev/null; then
            echo "[Host B] Instalando Docker..."
            if command -v amazon-linux-extras &> /dev/null; then
              sudo amazon-linux-extras install docker -y
            elif command -v dnf &> /dev/null; then
              sudo dnf install -y docker
            elif command -v apt-get &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y docker.io
            else
              sudo yum install -y docker
            fi
            sudo systemctl enable docker
            sudo systemctl start docker
          fi

          # ðŸ§© Instalar Docker Compose plugin se necessÃ¡rio
          if ! command -v docker-compose &> /dev/null; then
            echo "[Host B] Instalando Docker Compose..."
            DOCKER_COMPOSE_VERSION=2.24.0
            sudo curl -L "https://github.com/docker/compose/releases/download/v$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" \
              -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi

          echo "[Host B] âœ… Docker e Compose prontos."

          # ðŸ§© Subir containers
          cd "$DB_DIR"
          echo "[Host B] Parando containers antigos (se existirem)..."
          sudo docker compose down || true

          echo "[Host B] ðŸ—ï¸ Subindo containers com persistÃªncia..."
          sudo docker compose up -d --build

          echo "[Host B] âœ… Deploy completo! Containers ativos:"
          sudo docker ps
          EOF

          chmod +x "$PROJETO_DIR/deploy_on_b.sh"

      - name: BE - Deploy no Host Privado (via Bastion)
        run: |
          set -e
          mkdir -p logs
          
          HOST_A=${{ secrets.REMOTE_HOST }}
          HOST_B=${{ secrets.REMOTE_HOST_B }}
          USER=${{ secrets.REMOTE_USER }}
          KEY_PATH=~/.ssh/private_key.pem

          echo "ðŸ›°ï¸ Iniciando deploy completo (banco + backend) para $HOST_B via $HOST_A..."

          echo "ðŸ“¦ Enviando cÃ³digo completo para host_a..."
          rsync -rltgoDzvO --delete \
            -e "ssh -i $KEY_PATH -o StrictHostKeyChecking=no -o ServerAliveInterval=60" \
            "Sprint 4 - CleanArch/" \
            "$USER@$HOST_A:/home/$USER/backend_temp_deploy" \
            | tee logs/rsync_to_a.log

          echo "ðŸ”„ Copiando arquivos do bastion para host_b..."
          ssh -i $KEY_PATH -o StrictHostKeyChecking=no -o ServerAliveInterval=60 $USER@$HOST_A "\
            set -e && \
            echo '${{ secrets.EC2_SSH_KEY }}' > ~/private_key.pem && chmod 600 ~/private_key.pem && \
            rsync -rltgoDzvO --delete \
              -e 'ssh -i ~/private_key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=60' \
              /home/$USER/backend_temp_deploy/ \
              $USER@$HOST_B:/home/$USER/backend"

          echo "ðŸš€ Executando deploy_on_b.sh no host_b..."
          ssh -i $KEY_PATH -o StrictHostKeyChecking=no -o ServerAliveInterval=60 $USER@$HOST_A "\
            ssh -i ~/private_key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=60 $USER@$HOST_B 'bash /home/$USER/backend/JavaSpringBoot/projetoMima/deploy_on_b.sh'"
