version: '3.8'

services:
  # RabbitMQ - Fila de mensagens
  rabbitmq:
    image: rabbitmq:3-management
    container_name: mima-rabbitmq
    ports:
      - "5672:5672"    # AMQP
      - "15672:15672"  # Interface Web
    environment:
      RABBITMQ_DEFAULT_USER: myuser
      RABBITMQ_DEFAULT_PASS: secret
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - mima-network

  # Mailpit - Servidor SMTP local para testes (captura emails sem enviar de verdade)
  mailpit:
    image: axllent/mailpit
    container_name: mima-mailpit
    ports:
      - "1025:1025"  # SMTP (sem autenticação)
      - "8025:8025"  # Interface Web para ver emails
    networks:
      - mima-network

  # MailHog - Servidor SMTP alternativo (também captura localmente)
  mailhog:
    image: mailhog/mailhog
    container_name: mima-mailhog
    ports:
      - "1026:1025"  # SMTP alternativo
      - "8026:8025"  # Web UI
    networks:
      - mima-network

  # Postfix Relay - Servidor SMTP que ENVIA emails de verdade para internet
  postfix:
    image: boky/postfix
    container_name: mima-postfix
    restart: unless-stopped
    ports:
      - "2525:587"  # Porta exposta para conexão local (seu app usa essa)
    environment:
      - ALLOWED_SENDER_DOMAINS=mimastore.com
      - ALLOW_EMPTY_SENDER_DOMAINS=true
      # Se quiser relay via Gmail, SES, SendGrid configure no .env:
      - RELAYHOST=${RELAY_HOST:-}
      - RELAYHOST_USERNAME=${RELAY_USER:-}
      - RELAYHOST_PASSWORD=${RELAY_PASS:-}
      # Configurações adicionais
      - MESSAGE_SIZE_LIMIT=50000000
      - MASQUERADE_DOMAINS=mimastore.com
    networks:
      - mima-network

volumes:
  rabbitmq_data:

networks:
  mima-network:
    driver: bridge
